---
title: "`r format(Sys.time(), '%Y')` Icicle Creek Spring Chinook Salmon Forecast"
author: "Jakub Bednarek"
date: "Last updated `r format(Sys.time(), '%m/%d/%Y')`"
output: html_document
---

*This forecast is generated from publicly available data on PTAGIS.org, Columbia Basin Research DART, and from US Fish and Wildlife Service.*

PIT tags are used throughout the Columbia River Basin to track migratory fish behavior. This tool can be used to track run timing and forecast salmon escapement as fish begin to migrate up river. Based on initial tagging rates reported by Leavenworth National Fish Hatchery (LNFH) we can expand the observed counts at Bonneville Dam to forecast returns to Icicle Creek up to four weeks in advance of their arrival at Icicle Creek. This advanced notice can be used to inform harvest decisions and anticipate broodstock needs for LNFH. The forecast follows the model $$ N = (B * C) / P $$ where $B$ is the PIT count at Bonneville dam, $C$ is survival rate between Bonneville and Icicle Creek mouth (conversion rate), and $P$ is the proportion of run completed based on historical run timing characteristics (Columbia Basin DART, 2018). The conversion rate is estimated using PIT interrogation data at the ICL array in lower Icicle Creek and Bonneville dam. The ICL antenna was found to be 87% efficient at detecting migrating adults which was acounted for in calculating $C$ Bonneville dam counts are separated by brood year so that unique PIT tagging rates for each cohort can be applied. 

```{r setup, include=FALSE, warning=FALSE}
# Load libraries and import PTAGIS dataset
library(dplyr)
library(tidyr)
library(readxl)
library(lubridate)
library(stringr)
library(ggplot2)
#Import PTAGIS Dataset; Data was queried on PTAGIS for LNFH tagged fish
# migrating up the mainstem, including overshoots at TUF and RRF.
ftp_file_path = "ftp://ftp.ptagis.org/MicroStrategyExport/Bednarekuba/icicle_cr_forecast.csv"
LNFH_Returns <- read.csv(ftp_file_path, fileEncoding = "UTF-16LE")

#Clean and tidy the resulting table
#Convert datatypes
LNFH_Returns$Tag.Code <- as.character(LNFH_Returns$Tag.Code)
LNFH_Returns$Site.Name <- substr(LNFH_Returns$Site.Name,1,3)
LNFH_Returns$First.Obs.Date.Max <- mdy(LNFH_Returns$First.Obs.Date.Max)
# Select useful variables; rename columns to simplify; 
# mutate new columns "Age", and migration Year

cleanReturns <- LNFH_Returns %>%
  select(Tag.Code, Site.Name, Brood.Year.YYYY, First.Obs.Date.Max) %>%
  rename(TagCode = Tag.Code, SiteName = Site.Name, BroodYear = Brood.Year.YYYY,
         FirstObsDate = First.Obs.Date.Max) %>%
  mutate(MigrationYear = year(FirstObsDate), Age = MigrationYear - BroodYear) %>%
  filter(Age > 2 & Age < 7)

#spread Site to get site counts
site_counts <- cleanReturns %>% 
  count(MigrationYear, SiteName) %>% 
  spread(SiteName, n, fill=0) %>% 
  arrange(MigrationYear) %>% 
  filter(MigrationYear > 2011 & MigrationYear < year(Sys.Date())) %>%
  mutate(ConversionRate = (ICL / 0.87) / BON) #0.87 is the ICL efficiency

conversion_rate <- mean(site_counts$ConversionRate)


## Import Pit ratio and clean
pit_ratios <- read.csv("PITratios.csv") %>%
  mutate(BroodYear = Release.Year-2) %>%
  select(BroodYear, Release.Number, X..PIT, PIT.Ratio.Non.Tag.Tag) %>%
  rename(NumberTagged = X..PIT, pit_ratio = PIT.Ratio.Non.Tag.Tag) 

pit_ratios$BroodYear <- as.integer(pit_ratios$BroodYear)
pit_ratios$Release.Number <- as.integer( gsub(",", "", pit_ratios$Release.Number))
pit_ratios$NumberTagged <- as.integer( gsub(",","", pit_ratios$NumberTagged))
```

```{r echo = FALSE, warning = FALSE}
current_BONcounts <- cleanReturns %>% 
  count(MigrationYear, BroodYear, Age, SiteName) %>% 
  spread(SiteName, n, fill=0) %>% 
  select(MigrationYear, BroodYear, Age, BON) %>%
  filter(MigrationYear == year(Sys.Date())) ## replace 2017 with year(Sys.Date())

current_year <- data.frame(Age = as.integer(c(3,4,5)))
current_year <- current_year %>%
  mutate(BroodYear = as.integer(year(Sys.Date()))-Age) %>%
  left_join(select(current_BONcounts, BroodYear, BON), by = "BroodYear" ) %>%
  left_join(pit_ratios, by = "BroodYear") %>%
  mutate("Expanded Migration Size" = BON * pit_ratio) %>%
  rename("Brood Year" = BroodYear, "Bonneville Count" = BON, "Number Released" = Release.Number, "Number Tagged" = NumberTagged, "Ratio Released:Tagged" = pit_ratio)%>%
replace_na(list("Bonneville Count" = 0, "Expanded Migration Size" = 0)) 

library(knitr)
library(kableExtra)
kable(current_year, "html", align = "c", caption = "Table 1. 2018 LNFH origin spring Chinook Salmon migration characterists and migration size estimate.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")

```

### Total LNFH origin spring Chinook Salmon estimated at Bonneville: `r sum(current_year$"Expanded Migration Size")`

```{r include = FALSE}
# Run Timing Factorizaion
migration_filepath <- "hrt_pitadult.csv"
dart <- read.csv(migration_filepath)
dart <- dart[,1:10]


if (format(Sys.Date(), "%j") <= format(as.Date(dart[2,3], format="%m/%d"), "%j")) {
  percent_run <- 0.05
  } else if (format(Sys.Date(), "%j") > format(as.Date(dart[2,3], format="%m/%d"), "%j") &
         format(Sys.Date(), "%j") <= format(as.Date(dart[2,4], format="%m/%d"), "%j")){
    percent_run <- 0.10
  } else if (format(Sys.Date(), "%j") > format(as.Date(dart[2,4], format="%m/%d"), "%j") &
         format(Sys.Date(), "%j") <= format(as.Date(dart[2,5], format="%m/%d"), "%j")){
    percent_run <- 0.25
  } else if (format(Sys.Date(), "%j") > format(as.Date(dart[2,5], format="%m/%d"), "%j") &
         format(Sys.Date(), "%j") <= format(as.Date(dart[2,6], format="%m/%d"), "%j")) {
    percent_run <- 0.50
  } else if (format(Sys.Date(), "%j") > format(as.Date(dart[2,6], format="%m/%d"), "%j") &
         format(Sys.Date(), "%j") <= format(as.Date(dart[2,7], format="%m/%d"), "%j")) {
    percent_run <- 0.75
  } else if (format(Sys.Date(), "%j") > format(as.Date(dart[2,7], format="%m/%d"), "%j") &
         format(Sys.Date(), "%j") <= format(as.Date(dart[2,8], format="%m/%d"), "%j")) {
    percent_run <- 0.90
  } else if (format(Sys.Date(), "%j") > format(as.Date(dart[2,8], format="%m/%d"), "%j") &
         format(Sys.Date(), "%j") <= format(as.Date(dart[2,9], format="%m/%d"), "%j")) {
    percent_run <- 0.95
  } else percent_run <- 1 

```
### `r if (sum(current_year$"Expanded Migration Size") * conversion_rate / percent_run  < 1 ){
  "No PIT tags have been detected yet. Hopefully, fish come back this year!"
} else {
  paste("Forecast to Icicle Creek:", sum(current_year$"Expanded Migration Size") * conversion_rate / percent_run)
}`

Based on historical run timing characteristics the Icicle Creek spring Chinook run is `r paste((percent_run * 100), "%", sep = "")` (Columbia Basin Research DART 2018). Run timing characteristics are shown in Table 2. The average run timing may not closely represent this year's run. The run typically arrives later in high water years and earlier in low water years. In 2018 we observed slightly above average snowpack and may expect higher flows through the hydrosystem indicating a later return.  

```{r echo = FALSE}
dart %>% 
  kable("html",caption = "Table 2. Migration Timing Characteristics (Columbia Basin Research DART, 2018)", 
        align = "c", 
        col.names = c("Year", "First", "5% Passage", "10% Passage", "25% Passage", "50% Passage", "75% Passage", "90% Passage", "95% Passage", "Last")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

The following data shows the methods used to develop this forecast. Conversion rate, C, is calculated by Table 3. and represents the average survival of adults between Bonneville Dam and Lower Icicle Creek (ICL).The ICL array was installed in 2011 and available data includes 2012 to present.

```{r echo = FALSE}
site_counts %>%
  select(MigrationYear, BON, ICL, ConversionRate) %>%
  kable("html",col.names = c("Migration Year", "BON", "ICL", "Conversion Rate"), align = c("c", "c", "l"), caption = "Table 3. Historical PIT interrogations at Bonneville Dam (BON), Icicle Creek Lower Array (ICL) and resulting conversion rates. (PTAGIS, 2018)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

To gauge the strength of this model, I compared PIT expansions at Bonneville dam to actual returns to Icicle Creek. Icicle Creek returns are measured by hand counted returns to the hatchery, spawning ground surveys, and creel census of sport and tribal fisheries. These sources are used to reconstruct the total return to Icicle Creek. For years in which creel census data is not available, it was regressed.

```{r echo = FALSE}
library(readxl)
icicle_run_reconstruction <- read_excel(
  "Icicle R  Spring Chinook Run Reconstruction_01092018.xlsx", 
  sheet = "Icicle Run ReconstructionUpdate", 
  col_types = c("numeric", "numeric", "skip", 
  "numeric", "skip", "numeric", "numeric", 
  "text", "skip", "text", "skip", 
  "numeric", "skip", "numeric"), skip = 3)

ici_run <- icicle_run_reconstruction %>%
  select(Year, Run) %>%
  filter(!is.na(Year)) %>%
  rename(MigrationYear = Year)

ici_run$Run <- round(ici_run$Run, 0)

predicted <- cleanReturns %>% 
  count(MigrationYear, BroodYear,SiteName) %>% 
  spread(SiteName, n, fill=0) %>% 
  arrange(MigrationYear) %>% 
  filter(MigrationYear > 2011 & MigrationYear < year(Sys.Date())) %>%
  inner_join(pit_ratios, by = "BroodYear") %>%
  mutate(Forecast = round(BON*pit_ratio*conversion_rate, 0)) %>%
  group_by(MigrationYear) %>%
  summarize(Forecast = sum(Forecast)) %>%
  left_join(ici_run, by = "MigrationYear") %>%
  mutate(Difference = Forecast - Run, "Percent Diff" = round((100 * (Run-Forecast) / Run), 0) )
predicted %>%
kable("html",caption = "Table 4. Comparison of PIT expansion method and actual returns to Icicle Creek.") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

Table 4 shows the tendency of this forecast to under predict by an average `r paste(round(mean( predicted$'Percent Diff' ), 1), "%" , sep = "")`. This may be explained by research showing that PIT tagged fish have lower smolt to adult return rates (Knudsen, 2009, McDonald et al 2003, Prentice 1994) which would result in a slumping PIT ratio. We see a much larger deviation in 2015 where we had record high air and water temperatures. This was also one of the lowest water years in history for Icicle Creek. The exact cause is not known but explanations could include and increase in out of basin strays to Icicle Creek, reduced angling effort, or unsuccessful angling.

```{r echo = FALSE}
ggplot(predicted, aes(x = MigrationYear))+
  geom_line(aes(y = Forecast, color = "Forecast")) +
  geom_line(aes(y = Run, color = "Run"))+
  ggtitle("Comparison of Run Forecast to Actual Run")
```
